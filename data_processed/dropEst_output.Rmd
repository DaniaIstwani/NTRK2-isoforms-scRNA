---
title: "cc"
output: html_document
date: '2024-07-15'
---

## Load libraries

```{r}
library(Seurat)
library(cowplot)
library(dplyr)
library(ggplot2)
library(readr)
library(DT)
library(tidyr)
library(patchwork)
library(harmony)
library(CSCORE)
library(WGCNA)
library(pheatmap)
library(corrplot)
library(rtracklayer)
library(clusterProfiler)
library(org.Mm.eg.db)
library(enrichplot)
library(glmGamPoi)


source("/data/gpfs/projects/punim2183/data_processed/dropEst_analysis_functions.R")
#save.image(file = "dropEst_output.RData")
#load("dropEst_output.RData")

knitr::opts_chunk$set(eval = FALSE)
 # 
 # knitr::knit("dropEst_output.Rmd", output = "dropEst_output_analysis.md")

 #rmarkdown::render("dropEst_output.Rmd", output_format = "md_document", output_file = "dropEst_output_analysis.md")
```

The Following steps explain how the Dropest generated count matrices are converted and saved as an rds Seurat objects: 

## Step 1: Reading count matrices from a directory and createing Seurat objects:

For each count matrix type (trunc, FL, orig and both) generated by dropest using different gtf file.

```{r}

# Define the directory containing RDS files
rds_directory_both <- "/data/gpfs/projects/punim2183/samples_processing/count_matrix_files/both"

# Step 1: Read RDS files into Seurat objects
seurat_list_both <- read_rds_to_seurat(rds_directory_both)
```

# Step 2: Rename cells in the Seurat objects:

Extract naming patterns from the names of Seurat objects. And rename cell names in each Seurat object using the extracted naming patterns. Then combine multiple Seurat objects into a single Seurat object.

*Extract the naming pattern (e.g., "10X05_1")* 

**input** seurat_objects_both (a list of Seurat objects with names like count_matrix.rds_10X05_1.bam.1_both.gtf).


**Output** Each Seurat object in seurat_objects_both now has cell names prefixed with the corresponding naming pattern (e.g., "10X05_1\_Cell_1").

```{r}
seurat_list_both <- rename_cells_in_seurat_objects(seurat_list_both)
```

# Step 3: Normalize and merge Seurat objects


Normalise each seurat object then merge into one object. 

**Input:** List of seurat objects .

**Output:** A Normalised and merged Seurat object with:

```{r}
combined_seurat_both <- normalize_and_merge(seurat_list_both)
```

# Step 4: Update orig.ident metadata
 Update the orig.ident metadata column based on the sample names extracted from the cell names.

 **input:** merged seurat object, 
 **output:** updated metadata with correspondent cell names.
```{r}
combined_seurat_both <- update_orig_ident(combined_seurat_both)
```

# Step 5: Process the merged Seurat object

Process the combined Seurat object by scaling, clustering, and filtering the data. 

**Input:** combined_seurat_both (the combined Seurat object).

**Output:** A processed Seurat object with:

-   scaled data.

-   PCA (npc = 20), clustering, and UMAP performed.

-   Cells filtered based on mitochondrial content (percent.mt \< 5), feature count (nFeature_RNA \> 200 & nFeature_RNA \< 2000), and RNA count.

```{r}
combined_seurat_both <- process_seurat(combined_seurat_both)
```

# Step 6: Integrate datasets using Harmony

For addressing batch effect, grouped by orig.ident

```{r, echo=FALSE}
combined_seurat_both <- run_harmony(combined_seurat_both)
dimplot_orig_ident <- DimPlot(combined_seurat_both, reduction = "umap", group.by = "orig.ident") 

ggsave("dimplot_orig_ident.png", plot = dimplot_orig_ident, width = 10, height = 8, dpi = 300)
```

# Step 7: Save the final Seurat object

```{r, echo=FALSE}
save_seurat_object(combined_seurat_both, "combined_seurat_both.rds")

# Print a success message
print("Workflow completed successfully! The combined Seurat object has been saved.")
```




# Both Seurat

*Processing "Both" originated Seurat*

```{r, echo=FALSE}
# Define the directory containing RDS files
rds_directory_both <- "/data/gpfs/projects/punim2183/samples_processing/count_matrix_files/both/cm_both/"

# 1. Load with renaming data
seurat_list_both <- read_rds_to_seurat(rds_directory_both) |> rename_cells_in_seurat_objects()

seurat_list_both <- readRDS("/data/gpfs/projects/punim2183/data_processed/seurat_list_both.rds")
# 2. Normalize and merge
combined_seurat_both <- normalize_and_merge(seurat_list_both)

combined_seurat_both <- update_orig_ident(combined_seurat_both)

# 3. Process with Harmony integration
combined_seurat_both <- process_seurat(combined_seurat_both)
combined_seurat_both <- run_harmony(combined_seurat_both, group.by.vars = "orig.ident", npcs = 20)

# 4. Save the processed object
saveRDS(combined_seurat_both, "combined_seurat_both.rds")

# Print a success message
print("Workflow completed successfully! The combined Seurat object has been saved.")


```



Check the representation of the transcript isoforms as genes in the metadata
```{r, echo=FALSE}
isoforms_feature_plot <- FeaturePlot(combined_seurat_both, features = c("Ntrk2trunc", "Ntrk2FL"), raster = FALSE)
ggsave("isoforms_feature_plot.png", plot = isoforms_feature_plot, width = 10, height = 8, dpi = 300)

```


## Further processing: clustering and cell type annotation: 
Create clusters and annotate cell-types to clusters using marker genes of cell types of interest

Check reductions done to the object for clustering, and join assay layers for Seurat v5
```{r, echo=FALSE}
#saving files and loading the previous step to save computational time
#combined_seurat_both <- readRDS("/data/gpfs/projects/punim2183/data_processed/combined_seurat_both.rds")

names(combined_seurat_both@reductions)

combined_seurat_both <- JoinLayers(combined_seurat_both, assay = "RNA")

```

```{r, fig.width=12, fig.height=10, echo=FALSE}
# combined_seurat_both <- readRDS("/data/gpfs/projects/punim2183/data_processed/combined_seurat_both.rds")

neurons_markers = c("Map2", "Rbfox3", "Tubb3")
oligos_markers = c("Mbp", "Olig1", "Olig2")
astrocytes_markers = c("Gfap", "Aqp4", "Slc1a3")

count_expressing_cells <- function(markers, combined_seurat_both) {
  expression_data <- FetchData(combined_seurat_both, vars = markers)
  num_cells <- sum(rowSums(expression_data > 0) > 0)
  return(num_cells)
}

markers_feature_plot <- FeaturePlot(combined_seurat_both, c(neurons_markers, astrocytes_markers, oligos_markers), raster = FALSE)
markers_feature_plot
ggsave("markers_feature_plot.png", plot = markers_feature_plot, width = 10, height = 8, dpi = 300)


```

# Assign Clusters to cell types of interest

```{r, echo=FALSE}


cluster_to_celltype <- list(
Neurons = c(0, 1, 4, 14, 11, 26, 13, 12),
Oligo = c(6,24,22,17,16,27),
Astrocytes = c(15, 8, 3, 23, 25)
)
# Create a vector to store cell type labels
cell_type_labels <- rep(NA, ncol(combined_seurat_both))

# Assign specific cell types based on cluster IDs
for (cluster_id in 0:29) {
  if (cluster_id %in% cluster_to_celltype$Neurons) {
    cell_type_labels[combined_seurat_both$seurat_clusters == cluster_id] <- "Neurons"
  } else if (cluster_id %in% cluster_to_celltype$Oligo) {
    cell_type_labels[combined_seurat_both$seurat_clusters == cluster_id] <- "Oligo"
  } else if (cluster_id %in% cluster_to_celltype$Astrocytes) {
    cell_type_labels[combined_seurat_both$seurat_clusters == cluster_id] <- "Astrocytes"
  }
}

# Assign generic labels to remaining clusters
remaining_clusters <- setdiff(0:29, unlist(cluster_to_celltype))
for (i in seq_along(remaining_clusters)) {
  cell_type_labels[combined_seurat_both$seurat_clusters == remaining_clusters[i]] <- paste0("cell_type", i)
}

# Add the cell type labels to the Seurat object
combined_seurat_both$cell_type <- cell_type_labels

# Set the cell type as the active identity
Idents(combined_seurat_both) <- combined_seurat_both$cell_type
table(combined_seurat_both$cell_type)

dimplot_cell_types <- DimPlot(combined_seurat_both, reduction = "umap", label = TRUE, group.by = "cell_type", raster = FALSE)
dimplot_cell_types
ggsave("dimplot_cell_types.jpg", plot= dimplot_cell_types,width = 10, height = 8, dpi = 300)

#check metadata
Both_metadata <- combined_seurat_both@meta.data
head(Both_metadata)


```

## Subset seurat to cell types of interest for focused plotting 
```{r, echo=FALSE}
cell_types_of_interest <- c("Neurons", "Oligo", "Astrocytes")

subset_seurat_both <- subset(combined_seurat_both, subset = cell_type %in% cell_types_of_interest)


# Generate Plots
vln_plot <- VlnPlot(subset_seurat_both, features = c("Ntrk2FL", "Ntrk2trunc"), pt.size = 0)
feature_plot_both <- FeaturePlot(subset_seurat_both, features = c("Ntrk2FL", "Ntrk2trunc"), raster = FALSE)
feature_plot_trunc <- FeaturePlot(subset_seurat_both, features = "Ntrk2trunc", raster = FALSE)
feature_plot_fl <- FeaturePlot(subset_seurat_both, features = "Ntrk2FL", raster = FALSE)
dim_plot <- DimPlot(subset_seurat_both)

ggsave("feature_plot_both.png", plot = feature_plot_both, width = 10, height = 8, dpi = 300)
ggsave("feature_plot_trunc.png", plot = feature_plot_trunc, width = 10, height = 8, dpi = 300)
ggsave("feature_plot_fl.png", plot = feature_plot_fl, width = 10, height = 8, dpi = 300)
ggsave("dim_plot.png", plot = dim_plot, width = 10, height = 8, dpi = 300)
ggsave("vln_plot.png", plot = vln_plot, width = 10, height = 8, dpi = 300)

#saveRDS(subset_seurat_both, "subset_seurat_both.rds")
```



# CS_core/ gene co-expression
```{r, echo=FALSE}
subset_seurat_both <- readRDS("/data/gpfs/projects/punim2183/data_processed/subset_seurat_both.rds")


coexp_results <- run_CSCORE_on_Seurat_v5(
  seurat_object = subset_seurat_both,
  assay = "RNA",
  layer = "data",
  n_genes = 3000  
)

coexp_matrix <- coexp_results$coexpression_matrix
```



## gene co-expression analysis:
### Ntrk2trunc

```{r, echo=FALSE}

target_gene <- "Ntrk2trunc"

target_gene_expression_trunc <- coexp_matrix[target_gene, ]

# Calculate correlations
correlations <- apply(coexp_matrix, 1, function(gene_expression) {
  cor(target_gene_expression_trunc, gene_expression, method = "pearson")
})

# Convert to a data frame for easier handling
correlation_df_trunc <- data.frame(
  gene = names(correlations),
  correlation = correlations,
  row.names = NULL
)

# Sort by absolute correlation
correlation_df_trunc <- correlation_df_trunc[order(-abs(correlation_df_trunc$correlation)), ]

# Filter for significant correlations
significant_correlations_trunc <- correlation_df_trunc[abs(correlation_df_trunc$correlation) > 0.5, ] 
sig_genes_trunc <- significant_correlations_trunc$gene


genes_0.1_corr_trunc <- correlation_df_trunc[abs(correlation_df_trunc$correlation) > 0.1, ]
genes_0.2_corr_trunc <- correlation_df_trunc[abs(correlation_df_trunc$correlation) > 0.2, ]


# Plot the top 20 correlated genes (barplot)
top_20_genes_trunc <- head(significant_correlations_trunc, 20)
top_20_genes_barplot_trunc <- ggplot(top_20_genes_trunc, aes(x = reorder(gene, correlation), y = correlation)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  coord_flip() +
  labs(title = paste("Top Genes Correlated with", target_gene),
       x = "Gene",
       y = "Correlation") +
  theme_minimal()

top_20_genes_trunc$gene
ggsave("top_20_genes_barplot_trunc.png", plot = top_20_genes_barplot_trunc, width = 10, height = 8, dpi = 300)

# Extract the top 10 genes
top10_genes_trunc <- head((significant_correlations_trunc$gene), 11)

# Subset the expression matrix
heatmap_matrix_top10_trunc <- coexp_matrix[top10_genes_trunc, top10_genes_trunc]

# Check the dimensions of the heatmap matrix
dim(heatmap_matrix_top10_trunc)

# Plot heatmap

library(ComplexHeatmap)
library(circlize)
library(grid)

col_fun <- colorRamp2(c(0.7, 0.8 , 1), c("green", "yellow", "red"))

col_labels <- colnames(heatmap_matrix_top10_trunc)
row_labels <- rownames(heatmap_matrix_top10_trunc)

# Define styles for column names
row_font_colors_trunc <- ifelse(row_labels == "Ntrk2trunc", "red", "black")
col_font_colors_trunc <- ifelse(col_labels == "Ntrk2trunc", "red", "black")
col_font_face_trunc <- ifelse(col_labels == "Ntrk2trunc", "bold", "plain")

heatmap_plot_trunc <- Heatmap(heatmap_matrix_top10_trunc,
        name = "Correlation",
        col = col_fun,
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        row_names_gp = gpar(fontsize = 10, fontface = col_font_face_trunc, col = row_font_colors_trunc),
        column_names_gp = gpar(fontsize = 10, fontface = col_font_face_trunc, col = col_font_colors_trunc),
        column_names_rot = 45,
        rect_gp = gpar(col = "white", lwd = 1))


# Draw the heatmap
draw(heatmap_plot_trunc, 
     column_title= "Top 10 Genes Co-expressed with Ntrk2trunc",
   column_title_gp=grid::gpar(fontsize=16))

png("Ntrk2trunc_correlation_heatmap.png", width = 10, height = 8, units = "in", res = 300)  
draw(heatmap_plot_trunc,
     column_title = "Top 10 Genes Co-expressed with Ntrk2trunc",
     column_title_gp = gpar(fontsize = 16, fontface = "bold", col = "black"))
dev.off()  # Close the PNG device

```

### Ntrk2FL
```{r, echo=FALSE}
target_gene <- "Ntrk2FL"

target_gene_expression_FL <- coexp_matrix[target_gene, ]

# Calculate correlations
correlations <- apply(coexp_matrix, 1, function(gene_expression) {
  cor(target_gene_expression_FL, gene_expression, method = "pearson")
})

# Convert to a data frame for easier handling
correlation_df_FL <- data.frame(
  gene = names(correlations),
  correlation = correlations,
  row.names = NULL
)

# Sort by absolute correlation
correlation_df_FL <- correlation_df_FL[order(-abs(correlation_df_FL$correlation)), ]

# Filter for significant correlations
significant_correlations_FL <- correlation_df_FL[abs(correlation_df_FL$correlation) > 0.3, ] 
sig_genes_FL <- significant_correlations_FL$gene


genes_0.1_corr_FL <- correlation_df_FL[abs(correlation_df_FL$correlation) > 0.1, ]
genes_0.2_corr_FL <- correlation_df_FL[abs(correlation_df_FL$correlation) > 0.2, ]

# Plot the top 20 correlated genes
top_genes <- head(significant_correlations_FL, 20)
ggplot(top_genes, aes(x = reorder(gene, correlation), y = correlation)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  coord_flip() +
  labs(title = paste("Top Genes Correlated with", target_gene),
       x = "Gene",
       y = "Correlation") +
  theme_minimal()

top_genes$gene


# Extract the top 10 genes
top10_genes_FL <- head((significant_correlations_FL$gene), 11)

# Subset the expression matrix
heatmap_matrix_top10_FL <- coexp_matrix[top10_genes_FL, top10_genes_FL]

# Check the dimensions of the heatmap matrix
dim(heatmap_matrix_top10_FL)

# Plot heatmap

library(ComplexHeatmap)
library(circlize)
library(grid)

col_labels <- colnames(heatmap_matrix_top10_FL)
row_labels <- rownames(heatmap_matrix_top10_FL)

# Define styles for column names
row_font_colors_FL <- ifelse(row_labels == "Ntrk2FL", "red", "black")
col_font_colors_FL <- ifelse(col_labels == "Ntrk2FL", "red", "black")
col_font_face_FL <- ifelse(col_labels == "Ntrk2FL", "bold", "plain")


heatmap_plot_FL <- Heatmap(heatmap_matrix_top10_FL,
        name = "Correlation",
        col = col_fun,
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        row_names_gp = gpar(fontsize = 10, fontface = col_font_face_FL, col = row_font_colors_FL),
        column_names_gp = gpar(fontsize = 10, fontface = col_font_face_FL, col = col_font_colors_FL),
        column_names_rot = 45,
        rect_gp = gpar(col = "white", lwd = 1))


# Draw the heatmap
draw(heatmap_plot_FL, 
     column_title= "Top 10 Genes Co-expressed with Ntrk2FL",
   column_title_gp=grid::gpar(fontsize=16))

png("Ntrk2FL_correlation_heatmap.png", width = 10, height = 8, units = "in", res = 300)  
draw(heatmap_plot_FL,
     column_title = "Top 10 Genes Co-expressed with Ntrk2FL",
     column_title_gp = gpar(fontsize = 16, fontface = "bold", col = "black"))
dev.off()  # Close the PNG device



```



# GO enrichment
Prepare Gene Lists:

brain_gene_list_FL contains genes correlated with the full-length isoform (Ntrk2FL) with a correlation coefficient **(r) > 0.2**.

brain_gene_list_trunc contains genes correlated with the truncated isoform (Ntrk2trunc) with a correlation coefficient **(r) > 0.2**.

*Convert Gene Symbols to ENTREZ IDs:
Gene symbols (SYMBOL) are converted to ENTREZID format using the bitr function from clusterProfiler. This is necessary because GO enrichment analysis typically works with ENTREZID.

*Run GO Enrichment for Each Ontology:
The function is applied to both gene lists (for full-length and truncated isoforms) across three different GO ontologies: Biological Process (BP), Molecular Function (MF), and Cellular Component (CC).

*Generate Plots:
A GO enrichment dot plot is generated for each combination of gene list and ontology.

Biological Process (BP): GO terms related to biological functions and processes in the cell or organism.

Molecular Function (MF): GO terms that describe the molecular activities of the gene products.

Cellular Component (CC): GO terms related to the location of the gene product in the cell.

```{r, fig.width=10, fig.height=8, echo=FALSE}

brain_gene_list_FL <- genes_0.2_corr_FL$gene #correlated genes with Ntrk2 truncated isoform with r >0.2
brain_gene_list_trunc <- genes_0.2_corr_trunc$gene # correlated genes with full-length isoform with r > 0.2

#convert SYMBOL to ENTERZID 
converted_genes_trunc <- bitr(brain_gene_list_trunc, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Mm.eg.db)
brain_gene_list_trunc <- converted_genes_trunc$ENTREZID

converted_genes_FL <-bitr(brain_gene_list_FL, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Mm.eg.db)
brain_gene_list_FL <- converted_genes_FL$ENTREZID


# Run GO enrichment with converted gene IDs
go_plot_FL_cc <- plot_GO_enrichment(brain_gene_list_FL, gene_id_type = 'ENTREZID', 
                                 ontology = 'CC', pval_cutoff = 0.05, OrgDb = 'org.Mm.eg.db'+
                                 ggtitle("Gene Ontology Enrichment for Ntrk2FL"))

go_plot_trunc_cc <- plot_GO_enrichment(brain_gene_list_trunc, gene_id_type = 'ENTREZID', 
                                    ontology = 'CC', pval_cutoff = 0.05, OrgDb = 'org.Mm.eg.db'+
                                    ggtitle("Gene Ontology Enrichment for Ntrk2trunc"))

go_plot_FL_mf <- plot_GO_enrichment(brain_gene_list_FL, gene_id_type = 'ENTREZID', 
                                 ontology = 'MF', pval_cutoff = 0.05, OrgDb = 'org.Mm.eg.db'+
                                 ggtitle("Gene Ontology Enrichment for Ntrk2FL"))

go_plot_trunc_mf <- plot_GO_enrichment(brain_gene_list_trunc, gene_id_type = 'ENTREZID', 
                                    ontology = 'MF', pval_cutoff = 0.05, OrgDb = 'org.Mm.eg.db'+
                                    ggtitle("Gene Ontology Enrichment for Ntrk2trunc"))

go_plot_FL_bp <- plot_GO_enrichment(brain_gene_list_FL, gene_id_type = 'ENTREZID', 
                                 ontology = 'BP', pval_cutoff = 0.05, OrgDb = 'org.Mm.eg.db'+
                                 ggtitle("Gene Ontology Enrichment for Ntrk2FL"))

go_plot_trunc_bp <- plot_GO_enrichment(brain_gene_list_trunc, gene_id_type = 'ENTREZID', 
                                    ontology = 'BP', pval_cutoff = 0.05, OrgDb = 'org.Mm.eg.db'+
                                    ggtitle("Gene Ontology Enrichment for Ntrk2trunc"))


ggsave("go_plot_trunc_bp.png", plot = go_plot_trunc_bp, dpi = 300)
ggsave("go_plot_FL_bp.png", plot = go_plot_FL_bp, dpi = 300)

ggsave("go_plot_trunc_mf.png", plot = go_plot_trunc_mf, dpi = 300)
ggsave("go_plot_FL_mf.png", plot = go_plot_FL_mf, dpi = 300)

ggsave("go_plot_trunc_cc.png", plot = go_plot_trunc_cc, dpi = 300)
ggsave("go_plot_FL_cc.png", plot = go_plot_FL_cc, dpi = 300)

```




```{r}
# List of ontologies to loop through
ontologies <- c("BP", "MF", "CC")

# Function to generate plots for each ontology
generate_plots_for_ontology <- function(ontology) {
  
  # Compare GO terms for each cluster (trunc and FL)
  compare_go <- compareCluster(
    geneCluster = gene_lists,
    fun = "enrichGO",
    OrgDb = org.Mm.eg.db,
    keyType = "ENTREZID",
    ont = ontology,
    pvalueCutoff = 0.05,
    pAdjustMethod = "BH",
    qvalueCutoff = 0.2,
    readable = TRUE
  )
  
  go_df <- compare_go@compareClusterResult
  print(paste("Number of GO terms for ontology", ontology, ":", nrow(go_df)))  # Debugging
  
  # Filter significant results
  filtered_go <- go_df %>%
    filter(p.adjust < 0.05) %>%
    dplyr::select(Description, Cluster, p.adjust, GeneRatio)
  
  print(paste("Number of significant GO terms for ontology", ontology, ":", nrow(filtered_go)))  # Debugging
  
  # If there are no significant terms, stop the function here
  if (nrow(filtered_go) == 0) {
    print(paste("No significant GO terms for ontology", ontology))
    return(NULL)  # Exit if no significant results
  }
  
  # Separate by Cluster (FL vs trunc) and examine the differences
  fl_terms <- filtered_go %>% filter(Cluster == "FL")
  trunc_terms <- filtered_go %>% filter(Cluster == "trunc")
  
  # Identify the GO terms that are different (unique for each isoform)
  fl_unique <- setdiff(fl_terms$Description, trunc_terms$Description)
  trunc_unique <- setdiff(trunc_terms$Description, fl_terms$Description)
  
  # Select top N unique terms by significance (lowest p.adjust)

  top_n <- 15

  fl_top <- fl_terms %>%
  filter(Description %in% fl_unique) %>%
  arrange(p.adjust) %>%
  slice_head(n = top_n)

  trunc_top <- trunc_terms %>%
  filter(Description %in% trunc_unique) %>%
  arrange(p.adjust) %>%
  slice_head(n = top_n)

  
 top_unique_terms <- data.frame(
  Term = c(fl_top$Description, trunc_top$Description),
  Cluster = c(rep("FL", nrow(fl_top)), rep("trunc", nrow(trunc_top))),
  stringsAsFactors = FALSE
)
 
  # If there are no unique terms, stop the function here
  if (nrow(top_unique_terms) == 0) {
    print(paste("No unique GO terms for ontology", ontology))
    return(NULL)  # Exit if no unique terms
  }
  
  # Plot using ggplot
  p <- ggplot(top_unique_terms, aes(x = Term, y = Cluster, color = Cluster)) +
    geom_point(size = 4) +
    coord_flip() +
    labs(title = paste("Top Unique GO Terms:", ontology, "- Ntrk2FL vs Ntrk2trunc"),
         x = "GO Term", y = "Cluster") +
    scale_color_manual(values = c("blue", "red")) +  
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0),  
          plot.title.position = "plot",          
          axis.text.x = element_text(angle = 45, hjust = 1),
          axis.text.y = element_text(size = 10))
  print(p)
  
  ggsave(
  filename = paste0("GO_TopUnique_", ontology, ".png"),
  plot = p,
  width = 10,
  height = 6,
  dpi = 300
)
}
# Generate plots for each ontology
for (ontology in ontologies) {
  generate_plots_for_ontology(ontology)
}

```

# M10 Seurat

*Processing M10 originated Seurat*
```{r}
# Define the directory containing RDS files
rds_directory_orig <- "/data/gpfs/projects/punim2183/samples_processing/count_matrix_files/orig"

# 1. Load with renaming data
seurat_list_M10 <- read_rds_to_seurat(rds_directory_orig) |>
  rename_cells_in_seurat_objects()

# 2. Normalize with SCTransform and merge
combined_seurat_M10 <- normalize_and_merge(seurat_list_M10) |>
  update_orig_ident()

# 3. Process with Harmony integration
combined_seurat_M10 <- process_seurat(combined_seurat_M10) |>
  run_harmony()

# 4. Save the processed object
saveRDS(combined_seurat_M10, "combined_seurat_M10.rds")


# Print a success message
print("Workflow completed successfully! The combined Seurat object has been saved.")

```