---
title: "cc"
output: html_document
date: '2024-07-15'
---

```{r}
library(SeuratObject)
library(SeuratDisk)
library(Seurat)
library(cowplot)
library(dplyr)
library(ggplot2)
library(readr)
library(DT)
library(tidyr)
library(patchwork)
# if (!requireNamespace("rtracklayer", quietly = TRUE)) {
#     install.packages("BiocManager")
#     BiocManager::install("rtracklayer")
# }
# 
# library(rtracklayer)
# 
# save.image(file = "dropEst_output.RData")
# load("dropEst_output.RData")

```

##Reading count matrices from a directory and createing Seurat objects:

For each count matrix type (trunc, FL, orig and both) generated by dropest using different gtf file. 

```{r}

read_rds_to_seurat <- function(directory) {
  #function to read count matrices from a directory and create Seurat objects:
  rds_files <- list.files(directory, pattern = "\\.rds$", full.names = TRUE) # List all .rds files in the directory
  
  seurat_list <- list()
  
  for (file in rds_files) {
    sample_name <- tools::file_path_sans_ext(basename(file)) # Extract sample name from filename (remove directory and extension)

    
    # Read the RDS file
    count_matrix <- readRDS(file)
    
    seurat_obj <- CreateSeuratObject(counts = count_matrix$cm) # Create Seurat object (from the count_matrix 'cm' element)
    seurat_list[[sample_name]] <- seurat_obj
  }
  
  return(seurat_list)
}

#seurat_objects_orig <- read_rds_to_seurat("/data/gpfs/projects/punim2183/samples_processing/count_matrix_files/orig")

seurat_objects_trunc <- read_rds_to_seurat("/data/gpfs/projects/punim2183/samples_processing/count_matrix_files/trunc")

#seurat_objects_FL <- read_rds_to_seurat("/data/gpfs/projects/punim2183/samples_processing/count_matrix_files/FL")



```

Extract naming patterns from the names of Seurat objects. And rename cell names in each Seurat object using the extracted naming patterns.
Then combine multiple Seurat objects into a single Seurat object.

### Extract the naming pattern (e.g., "10X05_1")

*input:* seurat_objects_trunc (a list of Seurat objects with names like count_matrix.rds_10X05_1.bam.1_trunc.gtf).

*Output:* Each Seurat object in seurat_objects_trunc now has cell names prefixed with the corresponding naming pattern (e.g., "10X05_1_Cell_1").
```{r}

names_list <- names(seurat_objects_trunc)

naming_patterns <- gsub("^.*_(10X\\d+_\\d+)\\..*$", "\\1", names_list)

# Print the naming patterns
print(naming_patterns)

for (i in 1:length(seurat_objects_trunc)) {
    prefix <- naming_patterns[i]  

    current_cell_names <- colnames(seurat_objects_trunc[[i]])  

    new_cell_names <- paste0(prefix, "_", current_cell_names)  

    colnames(seurat_objects_trunc[[i]]) <- new_cell_names
}
```



### Combine Seurat objects

*Input:* seurat_objects_trunc (list of Seurat objects) and naming_patterns (vector of naming patterns).

*Output:* Each Seurat object in seurat_objects_trunc now has cell names prefixed with the corresponding naming pattern (e.g., "10X05_1_Cell_1").
```{r}

combined_seurat_trunc <- seurat_objects_trunc[[1]]
combined_seurat_trunc <- seurat_objects_trunc[[1]]  # Start with the first object
for (i in 2:length(seurat_objects_trunc)) {  # Loop from the 2nd to the last object
    combined_seurat_trunc <- merge(combined_seurat_trunc, seurat_objects_trunc[[i]])
}

# Verify unique cell names in the combined object
any(duplicated(colnames(combined_seurat_trunc)))

# Save the combined Seurat object (optional)
#saveRDS(combined_seurat_trunc, file = "combined_seurat_object_trunc.rds")


```


Preprocess the combined Seurat object by normalizing, scaling, clustering, and filtering the data. Then save the final Seurat object into an rds file format.

*Input:* combined_seurat_trunc (the combined Seurat object).

*Output:* A preprocessed (and saved) Seurat object with:

*Normalized and scaled data.

*PCA, clustering, and UMAP performed.

*Cells filtered based on mitochondrial content (percent.mt < 5), feature count (nFeature_RNA > 200 & nFeature_RNA < 2500), and RNA count.

```{r}
preprocess_seurat <- function(seurat_obj, dims = 1:10, resolution = 0.1) {
  seurat_obj <- NormalizeData(seurat_obj)
  seurat_obj <- FindVariableFeatures(seurat_obj)
  seurat_obj <- ScaleData(seurat_obj)
  seurat_obj <- RunPCA(seurat_obj)
  seurat_obj <- FindNeighbors(seurat_obj, dims = dims)
  seurat_obj <- FindClusters(seurat_obj, resolution = resolution)
  seurat_obj <- RunUMAP(seurat_obj, dims = dims)
  
  # Calculate mitochondrial percentage
  seurat_obj[["percent.mt"]] <- PercentageFeatureSet(seurat_obj, pattern = "^MT-")
  
  # Filter cells based on mitochondrial content, feature count, and RNA count
  seurat_obj <- subset(
    seurat_obj,
    subset = nFeature_RNA > 200 & nFeature_RNA < 2500 & percent.mt < 5
  )
  
  # Return the processed Seurat object
  return(seurat_obj)
}

combined_seurat_trunc <- preprocess_seurat(combined_seurat_trunc)
```

## Gene expression analysis: 

```{r}

gene_expression_Ntrk2_trunc <- FetchData(combined_seurat_trunc, vars = "Ntrk2")
total_expression_Ntrk2_trunc <- sum(gene_expression_Ntrk2$"Ntrk2")
total_expression_Ntrk2_trunc

FeaturePlot(combined_seurat_trunc, features = "Ntrk2")

```

```{r}

neurons_markers = c("Map2", "Rbfox3", "Tubb3")
oligos_markers = c("Mbp", "Olig1", "Olig2")
astrocytes_markers = c("Gfap", "Aqp4", "Slc1a3")

count_expressing_cells <- function(markers, seurat_obj) {
  expression_data <- FetchData(seurat_obj, vars = markers)
  num_cells <- sum(rowSums(expression_data > 0) > 0)
  return(num_cells)
}

# Count cells expressing each set of markers
neurons_cells_expressing <- count_expressing_cells(neurons_markers, seurat_obj_1)
oligos_cells_expressing <- count_expressing_cells(oligos_markers, seurat_obj_1)
astrocytes_cells_expressing <- count_expressing_cells(astrocytes_markers, seurat_obj_1)

print(paste("Number of cells expressing neuron markers:", neurons_cells_expressing))
print(paste("Number of cells expressing oligodendrocyte markers:", oligos_cells_expressing))
print(paste("Number of cells expressing astrocyte markers:", astrocytes_cells_expressing))
```

```{r}
FeaturePlot(seurat_obj_1, features = c("Map2", "Rbfox3", "Tubb3", "Mbp", "Olig1", "Olig2", "Gfap", "Aqp4", "Slc1a3"))
FeaturePlot(seurat_obj_1, features = "Ntrk2trunc")
FeaturePlot(seurat_obj_1, features = "Ntrk2FL")
# FeaturePlot(seurat_obj_1, features = "Ntrk2")


```

```{r}

gene_names <- c("Ntrk2trunc", "Ntrk2FL")  
gene_expression <- FetchData(seurat_obj_1, vars = gene_names)

num_cells_expressing <- list()

for (gene in gene_names) {
  num_cells_expressing[[gene]] <- sum(gene_expression[[gene]] > 0)
  print(paste("Number of cells expressing", gene, ":", num_cells_expressing[[gene]]))
}

```

```{r}
#cluster_markers <- FindAllMarkers(seurat_obj_1, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)

# cell type annotation
new_cluster_ids <- c("Astrocytes", "Cell_type_1", "Neurons", "Oligo", "Cell_type_2", "Cell_type_3", "Oligo", "Cell_type_4", "Cell_type_5", "Cell_type_6")
names(new_cluster_ids) <- levels(seurat_obj_1)
seurat_obj_1 <- RenameIdents(seurat_obj_1, new_cluster_ids)
Idents(seurat_obj_1)

# seurat_obj_1 <- SetIdent(seurat_obj_1, value = "seurat_clusters")


FeaturePlot(seurat_obj_1, features = neurons_markers)
FeaturePlot(seurat_obj_1, features = oligos_markers)
FeaturePlot(seurat_obj_1, features = astrocytes_markers)


VlnPlot(seurat_obj_1, features = neurons_markers, group.by = "seurat_clusters")
VlnPlot(seurat_obj_1, features = astrocytes_markers, group.by = "seurat_clusters")
VlnPlot(seurat_obj_1, features = oligos_markers, group.by = "seurat_clusters")



DotPlot(seurat_obj_1, features = c(neurons_markers, oligos_markers, astrocytes_markers)) + RotatedAxis()

```

```{r}
# subset the Seurat object to include only cell_types 
# subset_seurat <- subset(seurat_obj_1, idents = c("Astrocytes", "Neurons", "Oligo"))
                     

# VlnPlot(subset_seurat, features = "Ntrk2trunc")
# VlnPlot(subset_seurat, features = "Ntrk2FL")
VlnPlot(subset_seurat, features = gene_names)
expression_data <- FetchData(subset_seurat, vars = gene_names)


expression_summary <- expression_data %>%
  group_by(Idents(subset_seurat)) %>%
  summarise(across(everything(), mean, na.rm = TRUE))

print(expression_summary)

# DotPlot(subset_seurat, features = c("Ntrk2trunc", "Ntrk2FL"))
```

```{r}
# Duplicate Test of GeneX:
cell.counts_t <- readRDS("/data/gpfs/projects/punim2183/job_1_mod/cell.counts.rds")

seurat_obj_t <- CreateSeuratObject(counts = cell.counts_t$cm)

seurat_obj_t <- NormalizeData(seurat_obj_t)

seurat_obj_t <- FindVariableFeatures(seurat_obj_t)

seurat_obj_t <- ScaleData(seurat_obj_t)

seurat_obj_t <- RunPCA(seurat_obj_t)

seurat_obj_t <- FindNeighbors(seurat_obj_t, dims = 1:10)
seurat_obj_t <- FindClusters(seurat_obj_t, resolution = 0.1)

seurat_obj_t <- RunUMAP(seurat_obj_t, dims = 1:10)





FeaturePlot(seurat_obj_t, features= "Olig1")
gene_expression_olig1 <- FetchData(seurat_obj_t, vars = "Olig1")
total_expression_olig1 <- sum(gene_expression_olig1$"Olig1")
total_expression_olig1
gene_expression_x <- FetchData(seurat_obj_t, vars = "geneX")
total_expression_x <- sum(gene_expression_x$"geneX")
total_expression_x


```

```{r}
# Install the SeuratData package if needed
if (!requireNamespace("SeuratData", quietly = TRUE)) {
    install.packages("SeuratData")
}

# Load SeuratData package
library(SeuratData)

# Install the stxBrain dataset
SeuratData::InstallData("stxBrain")


options(timeout=600)
InstallData("stxBrain")
brain <- LoadData("stxBrain", type = "anterior1")
VlnPlot(brain, features = "nCount_Spatial", pt.size = 0.1, layer = "counts") + NoLegend()
SpatialPlot(brain, features = "nCount_Spatial", slot = "counts", image.alpha = 1)

# Normalization 
brain <- SCTransform(brain, assay = "Spatial", verbose = FALSE)  # For SCTransform normalization

#log1p
cMat <- brain[["Spatial"]]$counts
cMat <- log1p(cMat)
brain[["log1p"]] <- CreateAssayObject(
  data = cMat
)

SpatialFeaturePlot(brain, features = "Ntrk2")

```


