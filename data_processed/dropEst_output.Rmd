---
title: "cc"
output: html_document
date: '2024-07-15'
---

## Load libraries

```{r}
library(Seurat)
library(cowplot)
library(dplyr)
library(ggplot2)
library(readr)
library(DT)
library(tidyr)
library(patchwork)
library(harmony)
library(CSCORE)
library(WGCNA)
library(pheatmap)
library(corrplot)
library(rtracklayer)
library(clusterProfiler)
library(org.Mm.eg.db)
library(enrichplot)
library(glmGamPoi)


source("/data/gpfs/projects/punim2183/data_processed/dropEst_analysis_functions.R")
#save.image(file = "dropEst_output.RData")
#load("dropEst_output.RData")

 # knitr::opts_chunk$set(eval = FALSE)
 # 
 # knitr::knit("dropEst_output.Rmd", output = "dropEst_output_analysis.md")

 #rmarkdown::render("dropEst_output.Rmd", output_format = "md_document", output_file = "dropEst_output_analysis.md")
```

The Following steps explain how the Dropest generated count matrices are converted and saved as an rds Seurat objects: 

## Step 1: Reading count matrices from a directory and createing Seurat objects:

For each count matrix type (trunc, FL, orig and both) generated by dropest using different gtf file.

```{r}

# Define the directory containing RDS files
rds_directory_trunc <- "/data/gpfs/projects/punim2183/samples_processing/count_matrix_files/trunc"

# Step 1: Read RDS files into Seurat objects
seurat_list_trunc <- read_rds_to_seurat(rds_directory_trunc)
```

# Step 2: Rename cells in the Seurat objects:

Extract naming patterns from the names of Seurat objects. And rename cell names in each Seurat object using the extracted naming patterns. Then combine multiple Seurat objects into a single Seurat object.

*Extract the naming pattern (e.g., "10X05_1")* 

**input** seurat_objects_trunc (a list of Seurat objects with names like count_matrix.rds_10X05_1.bam.1_trunc.gtf).


**Output** Each Seurat object in seurat_objects_trunc now has cell names prefixed with the corresponding naming pattern (e.g., "10X05_1\_Cell_1").

```{r}
seurat_list_trunc <- rename_cells_in_seurat_objects(seurat_list_trunc)
```

# Step 3: Normalize and merge Seurat objects

Use SCT rather than logNormalisation because:
-Automatically Handles Sample Merging
Where the hashed code manually combines layers (data.1, data.2, ...) and normalizes per-sample, which is error-prone.

-SCTransform merges all samples while modeling technical variance (UMI depth, batch effects via orig.ident).

-Better Normalization
The hashed code uses crude log-normalization (RNA assay).

-SCTransform uses Pearson residuals (variance-stabilized), ideal for co-expression analysis.

-Simpler Workflow
No need to manually extract/cbind layers or calculate mean expression.

-SCTransform outputs a ready-to-use normalized matrix in the SCT assay. (Reference:  Hafemeister & Satija, 2019 (Genome Biology) )

Preprocess the combined Seurat object by normalizing the data. Then save the final Seurat object into an rds file format.

**Input:** List of seurat objects .

**Output:** A Normalised and merged Seurat object with:

```{r}
combined_seurat_trunc <- normalize_and_merge(seurat_list_trunc)
```

# Step 4: Update orig.ident metadata

```{r}
combined_seurat_trunc <- update_orig_ident(combined_seurat_trunc)
```

# Step 5: Process the merged Seurat object

Process the combined Seurat object by scaling, clustering, and filtering the data. 

**Input:** combined_seurat_trunc (the combined Seurat object).

**Output:** A processed Seurat object with:

-   scaled data.

-   PCA, clustering, and UMAP performed.

-   Cells filtered based on mitochondrial content (percent.mt \< 5), feature count (nFeature_RNA \> 200 & nFeature_RNA \< 2500), and RNA count.

```{r}
combined_seurat_trunc <- process_seurat(combined_seurat_trunc)
```

# Step 6: Integrate datasets using Harmony

For addressing batch effect, grouped by orig.ident (try Rpca)

```{r}
combined_seurat_trunc <- run_harmony(combined_seurat_trunc)
DimPlot(combined_seurat_trunc, reduction = "umap", group.by = "orig.ident") 
```

# Step 7: Save the final Seurat object

```{r}
save_seurat_object(combined_seurat_trunc, "combined_seurat_trunc.rds")

# Print a success message
print("Workflow completed successfully! The combined Seurat object has been saved.")
```

```{r}
#seurat_objects_orig <- read_rds_to_seurat("/data/gpfs/projects/punim2183/samples_processing/count_matrix_files/orig")

#seurat_objects_trunc <- read_rds_to_seurat("/data/gpfs/projects/punim2183/samples_processing/count_matrix_files/trunc")

#seurat_objects_FL <- read_rds_to_seurat("/data/gpfs/projects/punim2183/samples_processing/count_matrix_files/FL")



```


*Processing trunc originated Seurat*


```{r}
# Define the directory containing RDS files
rds_directory_trunc <- "/data/gpfs/projects/punim2183/samples_processing/count_matrix_files/trunc"

seurat_list_trunc <- read_rds_to_seurat(rds_directory_trunc)

seurat_list_trunc <- rename_cells_in_seurat_objects(seurat_list_trunc)

combined_seurat_trunc <- normalize_and_merge(seurat_list_trunc)

combined_seurat_trunc <- update_orig_ident(combined_seurat_trunc)

combined_seurat_trunc <- process_seurat(combined_seurat_trunc)

combined_seurat_trunc <- run_harmony(combined_seurat_trunc)

save_seurat_object(combined_seurat_trunc, "combined_seurat_trunc.rds")

# Print a success message
print("Workflow completed successfully! The combined Seurat object has been saved.")

```



*Processing FL originated Seurat*


```{r}
# Define the directory containing RDS files
rds_directory_FL <- "/data/gpfs/projects/punim2183/samples_processing/count_matrix_files/FL"

seurat_list_FL <- read_rds_to_seurat(rds_directory_FL)

seurat_list_FL <- rename_cells_in_seurat_objects(seurat_list_FL)

combined_seurat_FL <- normalize_and_merge(seurat_list_FL)

combined_seurat_FL <- update_orig_ident(combined_seurat_FL)

combined_seurat_FL <- process_seurat(combined_seurat_FL)

combined_seurat_FL <- run_harmony(combined_seurat_FL)

save_seurat_object(combined_seurat_FL, "combined_seurat_FL.rds")

# Print a success message
print("Workflow completed successfully! The combined Seurat object has been saved.")

```

*Processing "Both" originated Seurat*

```{r}
# Define the directory containing RDS files
rds_directory_both <- "/data/gpfs/projects/punim2183/samples_processing/count_matrix_files/both/cm_both/"

# 1. Load with renaming data
seurat_list_both <- read_rds_to_seurat(rds_directory_both) |>
  rename_cells_in_seurat_objects()

seurat_list_both <- readRDS("/data/gpfs/projects/punim2183/data_processed/seurat_list_both.rds")
# 2. Normalize with SCTransform and merge
combined_seurat_both <- normalize_and_merge(seurat_list_both)

combined_seurat_both <- update_orig_ident(combined_seurat_both)

# 3. Process with Harmony integration
combined_seurat_both <- process_seurat(combined_seurat_both)
combined_seurat_both <- run_harmony(combined_seurat_both, group.by.vars = "orig.ident", npcs = 20)

# 4. Save the processed object
saveRDS(combined_seurat_both, "combined_seurat_both.rds")

# 5. Run co-expression analysis (using SCT assay)
coexp_results <- run_CSCORE_on_Seurat_v5(
  seurat_object = combined_seurat_both,
  assay = "RNA",
  layer = "data",
  n_genes = 3000  
)
# Print a success message
print("Workflow completed successfully! The combined Seurat object has been saved.")

FeaturePlot(combined_seurat_both, features = c("Ntrk2trunc", "Ntrk2FL"))


```

*Processing M10 originated Seurat*
```{r}
# Define the directory containing RDS files
rds_directory_orig <- "/data/gpfs/projects/punim2183/samples_processing/count_matrix_files/orig"

# 1. Load with renaming data
seurat_list_M10 <- read_rds_to_seurat(rds_directory_orig) |>
  rename_cells_in_seurat_objects()

# 2. Normalize with SCTransform and merge
combined_seurat_M10 <- normalize_and_merge(seurat_list_M10) |>
  update_orig_ident()

# 3. Process with Harmony integration
combined_seurat_M10 <- process_seurat(combined_seurat_M10) |>
  run_harmony()

# 4. Save the processed object
saveRDS(combined_seurat_M10, "combined_seurat_M10.rds")


# Print a success message
print("Workflow completed successfully! The combined Seurat object has been saved.")

```



## Check the presence of transcript isoform(s) expression:

```{r}

gene_expression_Ntrk2_trunc <- FetchData(combined_seurat_trunc, vars = "Ntrk2trunc")
total_expression_Ntrk2_trunc <- sum(gene_expression_Ntrk2_trunc$"Ntrk2trunc")
total_expression_Ntrk2_trunc

FeaturePlot(combined_seurat_trunc, features = "Ntrk2trunc")

```

## Further analysis: 
Create clusters and annotate cell-types to clusters using marker genes of cell types of interest

```{r}
combined_seurat_both <- readRDS("/data/gpfs/projects/punim2183/data_processed/combined_seurat_both.rds")

names(combined_seurat_both@reductions)
DimPlot(combined_seurat_both, reduction = "umap", label = TRUE)
combined_seurat_both <- JoinLayers(combined_seurat_both, assay = "RNA")

```

```{r, fig.width=12, fig.height=10}
combined_seurat_both <- readRDS("/data/gpfs/projects/punim2183/data_processed/combined_seurat_both.rds")

neurons_markers = c("Map2", "Rbfox3", "Tubb3")
oligos_markers = c("Mbp", "Olig1", "Olig2")
astrocytes_markers = c("Gfap", "Aqp4", "Slc1a3")

count_expressing_cells <- function(markers, combined_seurat_both) {
  expression_data <- FetchData(combined_seurat_both, vars = markers)
  num_cells <- sum(rowSums(expression_data > 0) > 0)
  return(num_cells)
}

markers_feature_plot <- FeaturePlot(combined_seurat_both, c(neurons_markers, astrocytes_markers, oligos_markers), raster = FALSE)
markers_feature_plot
ggsave("markers_feature_plot.png", plot = markers_feature_plot, width = 10, height = 8, dpi = 300)


```

# Assign Clusters to cell types of interest

```{r}

# Join layers in the RNA assay
#combined_seurat_both <- JoinLayers(combined_seurat_both, assay = "RNA")

cluster_to_celltype <- list(
  Neurons = c(0, 2, 3, 11, 12, 13, 14, 20, 21, 22, 25, 27),
  Oligo = c(6, 10, 16, 24, 29),
  Astrocytes = c(1,7, 17, 23, 26, 28, 30)
)
# Create a vector to store cell type labels
cell_type_labels <- rep(NA, ncol(combined_seurat_both))

# Assign specific cell types based on cluster IDs
for (cluster_id in 0:30) {
  if (cluster_id %in% cluster_to_celltype$Neurons) {
    cell_type_labels[combined_seurat_both$seurat_clusters == cluster_id] <- "Neurons"
  } else if (cluster_id %in% cluster_to_celltype$Oligo) {
    cell_type_labels[combined_seurat_both$seurat_clusters == cluster_id] <- "Oligo"
  } else if (cluster_id %in% cluster_to_celltype$Astrocytes) {
    cell_type_labels[combined_seurat_both$seurat_clusters == cluster_id] <- "Astrocytes"
  }
}

# Assign generic labels to remaining clusters
remaining_clusters <- setdiff(0:30, unlist(cluster_to_celltype))
for (i in seq_along(remaining_clusters)) {
  cell_type_labels[combined_seurat_both$seurat_clusters == remaining_clusters[i]] <- paste0("cell_type", i)
}

# Add the cell type labels to the Seurat object
combined_seurat_both$cell_type <- cell_type_labels

# Set the cell type as the active identity
Idents(combined_seurat_both) <- combined_seurat_both$cell_type
table(combined_seurat_both$cell_type)

DimPlot(combined_seurat_both, reduction = "umap", label = TRUE, group.by = "cell_type")


# Extract metadata

Both_metadata <- combined_seurat_both@meta.data
head(Both_metadata)


# Filter metadata for cell_type1, cell_type9, and cell_type10
cell_type_info <- Both_metadata[Both_metadata$cell_type %in% c("cell_type5"), ]

# Select only the relevant columns
cell_type_info <- cell_type_info[, c("seurat_clusters", "cell_type")]

# Remove duplicate rows
cell_type_info <- unique(cell_type_info)

# View the result
print(cell_type_info)

genes_of_interest = c("Ntrk2FL", "Ntrk2trunc")

VlnPlot(combined_seurat_both, features = genes_of_interest, group.by = "cell_type", stack = TRUE, flip = TRUE)

# markers_cell_type7 <- FindMarkers(combined_seurat_both, ident.1 = "cell_type7")
# print(head(markers_cell_type7))

```

## Subset seurat to cell types of interest for focused plotting 
```{r, fig.width=8}
cell_types_of_interest <- c("Neurons", "Oligo", "Astrocytes")

subset_seurat_both <- subset(combined_seurat_both, subset = cell_type %in% cell_types_of_interest)

genes_of_interest <- c("Ntrk2FL", "Ntrk2trunc", neurons_markers, astrocytes_markers)  

# Define colors for each group
neurons_colors <- c("#1f77b4", "#aec7e8", "#6baed6", "#4292c6")  # Shades of blue
astrocytes_colors <- c("#2ca02c", "#98df8a", "#66c2a4", "#238b45")  # Shades of green

#VlnPlot(subset_seurat, features = genes_of_interest, group.by = "cell_type", stack = TRUE, flip = TRUE)

# Plot for Ntrk2FL + neurons markers
neurons_plot <- VlnPlot(
  subset_seurat_both,
  features = c(neurons_markers, "Ntrk2FL"),
  group.by = "cell_type",
  cols = neurons_colors,  # Use shades of blue
  pt.size = 0,  # Remove points for clarity
  stack = TRUE,
  flip = TRUE
) +
  ggtitle("Ntrk2FL and Neurons Markers") +
  theme(legend.position = "none")  # Remove legend for cleaner plot

# Plot for Ntrk2trunc + astrocytes markers
astrocytes_plot <- VlnPlot(
  subset_seurat_both,
  features = c(astrocytes_markers,"Ntrk2trunc"),
  group.by = "cell_type",
  cols = astrocytes_colors,  # Use shades of green
  pt.size = 0,  # Remove points for clarity
  stack = TRUE,
  flip = TRUE, 
  raster = FALSE
) +
  ggtitle("Ntrk2trunc and Astrocytes Markers") +
  theme(legend.position = "none")  # Remove legend for cleaner plot

# Combine plots side by side
combined_plot <- neurons_plot | astrocytes_plot

# Display the combined plot
combined_plot
VlnPlot(subset_seurat_both, features = c("Ntrk2FL", "Ntrk2trunc"), pt.size = 0)

# Generate Plots
vln_plot <- VlnPlot(subset_seurat_both, features = c("Ntrk2FL", "Ntrk2trunc"), pt.size = 0)
feature_plot_both <- FeaturePlot(subset_seurat_both, features = c("Ntrk2FL", "Ntrk2trunc"), raster = FALSE)
feature_plot_trunc <- FeaturePlot(subset_seurat_both, features = "Ntrk2trunc", raster = FALSE)
feature_plot_fl <- FeaturePlot(subset_seurat_both, features = "Ntrk2FL", raster = FALSE)
dim_plot <- DimPlot(subset_seurat_both)

ggsave("feature_plot_both.png", plot = feature_plot_both, width = 10, height = 8, dpi = 300)
ggsave("feature_plot_trunc.png", plot = feature_plot_trunc, width = 10, height = 8, dpi = 300)
ggsave("feature_plot_fl.png", plot = feature_plot_fl, width = 10, height = 8, dpi = 300)
ggsave("dim_plot.png", plot = dim_plot, width = 10, height = 8, dpi = 300)
ggsave("vln_plot.png", plot = vln_plot, width = 10, height = 8, dpi = 300)

#saveRDS(subset_seurat_both, "subset_seurat_both.rds")
```

the following code to check Gfap expression
```{r}
# gfap_expression <- FetchData(combined_seurat_both, vars = "Gfap")
# 
# gfap_expression$cell_type <- combined_seurat_both$cell_type
# 
# # Plot Gfap expression across cell types
# ggplot(gfap_expression, aes(x = cell_type, y = Gfap, fill = cell_type)) +
#   geom_violin(scale = "width", trim = TRUE) +
#   theme_minimal() +
#   labs(title = "Gfap Expression Across Cell Types", x = "Cell Type", y = "Expression Level")
```

# CS_core/ gene co-expression
```{r}
subset_seurat_both <- readRDS("/data/gpfs/projects/punim2183/data_processed/subset_seurat_both.rds")

# Merge layers explicitly 
subset_seurat_both <- JoinLayers(subset_seurat_both, assay = "RNA")

coexp_results <- run_CSCORE_on_Seurat_v5(
  seurat_object = subset_seurat_both,
  assay = "RNA",
  layer = "data",
  n_genes = 3000  
)

coexp_matrix <- coexp_results$coexpression_matrix
```



## gene co-expression analysis:
### Ntrk2trunc

```{r}

target_gene <- "Ntrk2trunc"

target_gene_expression_trunc <- coexp_matrix[target_gene, ]

# Calculate correlations
correlations <- apply(coexp_matrix, 1, function(gene_expression) {
  cor(target_gene_expression_trunc, gene_expression, method = "pearson")
})

# Convert to a data frame for easier handling
correlation_df_trunc <- data.frame(
  gene = names(correlations),
  correlation = correlations,
  row.names = NULL
)

# Sort by absolute correlation
correlation_df_trunc <- correlation_df_trunc[order(-abs(correlation_df_trunc$correlation)), ]

# Filter for significant correlations
significant_correlations_trunc <- correlation_df_trunc[abs(correlation_df_trunc$correlation) > 0.5, ] 
sig_genes_trunc <- significant_correlations_trunc$gene


genes_0.1_corr_trunc <- correlation_df_trunc[abs(correlation_df_trunc$correlation) > 0.1, ]
genes_0.2_corr_trunc <- correlation_df_trunc[abs(correlation_df_trunc$correlation) > 0.2, ]


# Plot the top 20 correlated genes
top_genes <- head(significant_correlations_trunc, 20)
ggplot(top_genes, aes(x = reorder(gene, correlation), y = correlation)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  coord_flip() +
  labs(title = paste("Top Genes Correlated with", target_gene),
       x = "Gene",
       y = "Correlation") +
  theme_minimal()

top_genes$gene


# Extract the top 10 genes
top10_genes_trunc <- head((significant_correlations_trunc$gene), 11)

# Subset the expression matrix
heatmap_matrix_top10_trunc <- coexp_matrix[top10_genes_trunc, top10_genes_trunc]

# Check the dimensions of the heatmap matrix
dim(heatmap_matrix_top10_trunc)

# Plot heatmap

library(ComplexHeatmap)
library(circlize)
library(grid)

col_fun <- colorRamp2(c(0.3, 0.6, 1), c("green", "yellow", "red"))

col_labels <- colnames(heatmap_matrix_top10_trunc)

# Define styles for column names
col_font_colors <- ifelse(col_labels == "Ntrk2trunc", "red", "black")
col_font_face <- ifelse(col_labels == "Ntrk2trunc", "bold", "plain")

heatmap_plot_trunc <- Heatmap(heatmap_matrix_top10_trunc,
        name = "Correlation",
        col = col_fun,
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        row_names_gp = gpar(fontsize = 10, fontface = row_font_face, col = row_font_colors),
        column_names_gp = gpar(fontsize = 10, fontface = col_font_face, col = col_font_colors),
        column_names_rot = 45,
        rect_gp = gpar(col = "white", lwd = 1))


# Draw the heatmap
draw(heatmap_plot_trunc, 
     column_title= "Top 10 Genes Co-expressed with Ntrk2trunc",
   column_title_gp=grid::gpar(fontsize=16))

png("Ntrk2trunc_correlation_heatmap.png", width = 10, height = 8, units = "in", res = 300)  
draw(heatmap_plot_trunc,
     column_title = title_text,
     column_title_gp = gpar(fontsize = 16, fontface = "bold", col = "black"))
dev.off()  # Close the PNG device

```

### Ntrk2FL
```{r}
target_gene <- "Ntrk2FL"

target_gene_expression_FL <- coexp_matrix[target_gene, ]

# Calculate correlations
correlations <- apply(coexp_matrix, 1, function(gene_expression) {
  cor(target_gene_expression_FL, gene_expression, method = "pearson")
})

# Convert to a data frame for easier handling
correlation_df_FL <- data.frame(
  gene = names(correlations),
  correlation = correlations,
  row.names = NULL
)

# Sort by absolute correlation
correlation_df_FL <- correlation_df_FL[order(-abs(correlation_df_FL$correlation)), ]

# Filter for significant correlations
significant_correlations_FL <- correlation_df_FL[abs(correlation_df_FL$correlation) > 0.3, ] 
sig_genes_FL <- significant_correlations_FL$gene


genes_0.1_corr_FL <- correlation_df_FL[abs(correlation_df_FL$correlation) > 0.1, ]
genes_0.2_corr_FL <- correlation_df_FL[abs(correlation_df_FL$correlation) > 0.2, ]

# Plot the top 20 correlated genes
top_genes <- head(significant_correlations_FL, 20)
ggplot(top_genes, aes(x = reorder(gene, correlation), y = correlation)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  coord_flip() +
  labs(title = paste("Top Genes Correlated with", target_gene),
       x = "Gene",
       y = "Correlation") +
  theme_minimal()

top_genes$gene


# Extract the top 10 genes
top10_genes_FL <- head((significant_correlations_FL$gene), 11)

# Subset the expression matrix
heatmap_matrix_top10_FL <- coexp_matrix[top10_genes_FL, top10_genes_FL]

# Check the dimensions of the heatmap matrix
dim(heatmap_matrix_top10_FL)

# Plot heatmap

library(ComplexHeatmap)
library(circlize)
library(grid)

col_fun <- colorRamp2(c(0.3, 0.6, 1), c("green", "yellow", "red"))

col_labels <- colnames(heatmap_matrix_top10_FL)

# Define styles for column names
col_font_colors <- ifelse(col_labels == "Ntrk2FL", "red", "black")
col_font_face <- ifelse(col_labels == "", "bold", "plain")


heatmap_plot_FL <- Heatmap(heatmap_matrix_top10_FL,
        name = "Correlation",
        col = col_fun,
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        row_names_gp = gpar(fontsize = 10, fontface = row_font_face, col = row_font_colors),
        column_names_gp = gpar(fontsize = 10, fontface = col_font_face, col = col_font_colors),
        column_names_rot = 45,
        rect_gp = gpar(col = "white", lwd = 1))


# Draw the heatmap
draw(heatmap_plot_FL, 
     column_title= "Top 10 Genes Co-expressed with Ntrk2FL",
   column_title_gp=grid::gpar(fontsize=16))

png("Ntrk2FL_correlation_heatmap.png", width = 10, height = 8, units = "in", res = 300)  
draw(heatmap_plot_FL,
     column_title = title_text,
     column_title_gp = gpar(fontsize = 16, fontface = "bold", col = "black"))
dev.off()  # Close the PNG device



```



# GO enrichment

```{r, fig.width=10, fig.height=8}

plot_GO_enrichment <- function(gene_name_vector, gene_id_type = 'SYMBOL', ontology = 'BP', pval_cutoff = 0.2, OrgDb = 'org.Mm.eg.db'){
  # Taking a vector of gene names, plot GO enrichment dotplot. Default ontology is biological process. 
  
  enrich_obj <- enrichGO(gene = gene_name_vector,
                         OrgDb = 'org.Mm.eg.db', 
                         keyType = gene_id_type, 
                         ont = ontology, 
                         pAdjustMethod = "BH",
                         pvalueCutoff = pval_cutoff)
  
  enrichplot::dotplot(enrich_obj, 
                      label_format = 100)
  }

brain_gene_list_FL <- genes_0.2_corr_FL$gene #correlated genes with Ntrk2 truncated isoform with r >0.2
brain_gene_list_trunc <- genes_0.2_corr_trunc$gene # correlated genes with full-length isoform with r > 0.2

# Convert gene symbols to ENTREZID

# converted_genes_trunc <- bitr(brain_gene_list_trunc, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Mm.eg.db)
# brain_gene_list_trunc <- converted_genes_trunc$ENTREZID
# 
# converted_genes_FL <-bitr(brain_gene_list_FL, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Mm.eg.db)
# brain_gene_list_FL <- converted_genes_FL$ENTREZID

# Run GO enrichment with converted gene IDs
go_plot_FL_cc <- plot_GO_enrichment(brain_gene_list_FL, gene_id_type = 'SYMBOL', 
                                 ontology = 'CC', pval_cutoff = 0.05, OrgDb = 'org.Mm.eg.db'+
                                 ggtitle("Gene Ontology Enrichment for Ntrk2FL"))

go_plot_trunc_cc <- plot_GO_enrichment(brain_gene_list_trunc, gene_id_type = 'SYMBOL', 
                                    ontology = 'CC', pval_cutoff = 0.05, OrgDb = 'org.Mm.eg.db'+
                                    ggtitle("Gene Ontology Enrichment for Ntrk2trunc"))

go_plot_FL_mf <- plot_GO_enrichment(brain_gene_list_FL, gene_id_type = 'SYMBOL', 
                                 ontology = 'MF', pval_cutoff = 0.05, OrgDb = 'org.Mm.eg.db'+
                                 ggtitle("Gene Ontology Enrichment for Ntrk2FL"))

go_plot_trunc_mf <- plot_GO_enrichment(brain_gene_list_trunc, gene_id_type = 'SYMBOL', 
                                    ontology = 'MF', pval_cutoff = 0.05, OrgDb = 'org.Mm.eg.db'+
                                    ggtitle("Gene Ontology Enrichment for Ntrk2trunc"))

go_plot_FL_bp <- plot_GO_enrichment(brain_gene_list_FL, gene_id_type = 'SYMBOL', 
                                 ontology = 'BP', pval_cutoff = 0.05, OrgDb = 'org.Mm.eg.db'+
                                 ggtitle("Gene Ontology Enrichment for Ntrk2FL"))

go_plot_trunc_bp <- plot_GO_enrichment(brain_gene_list_trunc, gene_id_type = 'SYMBOL', 
                                    ontology = 'BP', pval_cutoff = 0.05, OrgDb = 'org.Mm.eg.db'+
                                    ggtitle("Gene Ontology Enrichment for Ntrk2trunc"))

go_plot_FL_bp
go_plot_trunc_bp

```


```{r}
# Get the GO results for Cellular Component
go_results <- enrichGO(gene = gene_ids$SYMBOL, OrgDb = org.Mm.eg.db, ont = "CC", pvalueCutoff = 0.05)

# Create a custom bar plot of the GO results
ggplot(go_results@result, aes(x = reorder(Description, -p.adjust), y = -log10(p.adjust))) +
    geom_bar(stat = "identity", fill = "skyblue") +
    coord_flip() + 
    theme_minimal() +
    xlab("GO Terms") +
    ylab("-log10 Adjusted P-Value") +
    ggtitle("GO Enrichment - Cellular Component")


go_data <- go_results@result

# Custom ggplot for GO term enrichment
ggplot(go_data, aes(x = reorder(Description, -Count), y = Count, fill = -log10(p.adjust))) +
    geom_bar(stat = "identity") +
    coord_flip() +
    scale_fill_gradient(low = "blue", high = "red") +
    labs(x = "GO Terms", y = "Gene Count", title = "GO Enrichment for Ntrk2FL") +
    theme_minimal()


```

