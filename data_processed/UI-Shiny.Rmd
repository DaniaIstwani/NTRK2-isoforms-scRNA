---
title: "Rshiny"
output: html_document
date: '2024-11-19'
---

```{r}
install.packages("shiny")
install.packages("Seurat")
install.packages("ggplot2")
install.packages("patchwork")  

library(shiny)
library(Seurat)
library(ggplot2)
library(patchwork)

```


```{r}

# library(shiny)
# library(Seurat)
# library(ggplot2)
# library(patchwork)
# library(shinycssloaders)
# library(future)
# library(promises)

plan(multisession)  # Enable parallel processing

seurat_dir <- "/data/gpfs/projects/punim2183/data_processed/"
seurat_objects <- c(
  "Both_Isoforms_Seurat.rds",
  "combined_seurat_FL.rds",
  "combined_seurat_trunc.rds"
)

# Global cache to store metadata only
seurat_metadata_cache <- new.env()

ui <- fluidPage(
  titlePanel("Seurat Object Explorer"),
  sidebarLayout(
    sidebarPanel(
      selectInput("object1", "Choose Seurat Object 1", choices = seurat_objects),
      selectInput("object2", "Choose Seurat Object 2", choices = seurat_objects),
      textInput ("gene1", "Select Gene for Object 1", value = ""),
      textInput("gene2", "Select Gene for Object 2", value = ""),
      #selectInput("cell_type", "Choose Cell Type(s)", choices = NULL, multiple = TRUE),
      radioButtons("plot_type", "Choose Plot Type",
                   choices = c("Feature Plot", "Violin Plot", "Both"),
                   selected = "Feature Plot"),
      actionButton("plot", "Generate Data")
    ),
    mainPanel(
      verbatimTextOutput("gene_expression1"),
      verbatimTextOutput("gene_expression2")
      # conditionalPanel(
      #   condition = "input.plot_type == 'Feature Plot' || input.plot_type == 'Both'",
      #   h4("Feature Plot"),
      #   fluidRow(
      #     column(6, withSpinner(plotOutput("feature_plot1"))),
      #     column(6, withSpinner(plotOutput("feature_plot2")))
      #   )
      # ),
      # conditionalPanel(
      #   condition = "input.plot_type == 'Violin Plot' || input.plot_type == 'Both'",
      #   h4("Violin Plot"),
      #   fluidRow(
      #     column(6, withSpinner(plotOutput("violin_plot1"))),
      #     column(6, withSpinner(plotOutput("violin_plot2")))
      #   )
      # )
    )
  )
)

server <- function(input, output, session) {
  loadSeuratMetadata <- function(object_name) {
    object_path <- file.path(seurat_dir, object_name)
    if (!exists(object_name, envir = seurat_metadata_cache) && file.exists(object_path)) {
      seurat_obj <- readRDS(object_path)
      metadata <-
      genes = rownames(seurat_obj[["RNA"]]@data) 
      assign(object_name, metadata, envir = seurat_metadata_cache)
    }
    get(object_name, envir = seurat_metadata_cache)
  }
  
  observeEvent(input$object1, {
    req(input$object1)
    showNotification(paste("Loading metadata for", input$object1, "..."), type = "message")
    future({ loadSeuratMetadata(input$object1) }) %...>% {
      metadata <- .
      updateSelectInput(session, "gene1", choices = metadata$genes)
      showNotification(paste("Metadata for", input$object1, "loaded successfully!"), type = "message")
    } %...!% {
      showNotification("Error loading metadata!", type = "error")
    }
  })
  
  observeEvent(input$object2, {
    req(input$object2)
    showNotification(paste("Loading metadata for", input$object2, "..."), type = "message")
    future({ loadSeuratMetadata(input$object2) }) %...>% {
      metadata <- .
      updateSelectInput(session, "gene2", choices = metadata$genes)
      showNotification(paste("Metadata for", input$object2, "loaded successfully!"), type = "message")
    } %...!% {
      showNotification("Error loading metadata!", type = "error")
    }
  })
  
  observeEvent(input$plot, {
    req(input$object1, input$gene1)
    
    future({
      object_path1 <- file.path(seurat_dir, input$object1)
      seurat1 <- readRDS(object_path1)
      #filtered_seurat1 <- subset(seurat1, subset = cell_type %in% input$cell_type)
      gene_expression1 <- FetchData(seurat1, vars = input$gene1)
      gc()
      
      seurat2 <- NULL
      gene_expression2 <- NULL
      if (!is.null(input$object2)) {
        object_path2 <- file.path(seurat_dir, input$object2)
        seurat2 <- readRDS(object_path2)
        #filtered_seurat2 <- subset(seurat2, subset = cell_type %in% input$cell_type)
        gene_expression2 <- FetchData(seurat2, vars = input$gene2)
        gc()
      }
      
      list(gene_expression1, gene_expression2)
    }) %...>% { data ->
      output$gene_expression1 <- renderPrint({ data[[1]] })
      output$gene_expression2 <- renderPrint({ data[[2]] })
    }
  })
}

shinyApp(ui = ui, server = server)


```

```{r}
library(shiny)
library(Seurat)
library(ggplot2)
library(patchwork)

# Define the directory containing Seurat objects
seurat_dir <- "/data/gpfs/projects/punim2183/data_processed/"

# List all .RDS files in the directory
seurat_files <- list.files(seurat_dir, pattern = "\\.RDS$", full.names = FALSE)

# Define UI
ui <- fluidPage(
  titlePanel("Seurat Object Explorer"),
  sidebarLayout(
    sidebarPanel(
      selectInput("object1", "Choose Seurat Object 1", choices = seurat_files),
      selectInput("object2", "Choose Seurat Object 2", choices = seurat_files),
      textInput("gene1", "Enter Gene for Object 1", value = ""),
      textInput("gene2", "Enter Gene for Object 2", value = ""),
      selectInput("cell_type", "Choose Cell Type", choices = NULL),
      radioButtons("plot_type", "Choose Plot Type",
                   choices = c("Feature Plot", "Violin Plot", "Both"),
                   selected = "Both"),
      actionButton("plot", "Generate Plots")
    ),
    mainPanel(
      conditionalPanel(
        condition = "input.plot_type == 'Feature Plot' || input.plot_type == 'Both'",
        h4("Feature Plot"),
        fluidRow(
          column(6, plotOutput("feature_plot1")),
          column(6, plotOutput("feature_plot2"))
        )
      ),
      conditionalPanel(
        condition = "input.plot_type == 'Violin Plot' || input.plot_type == 'Both'",
        h4("Violin Plot"),
        fluidRow(
          column(6, plotOutput("violin_plot1")),
          column(6, plotOutput("violin_plot2"))
        )
      )
    )
  )
)

# Define server logic
server <- function(input, output, session) {
  # Reactive values to store Seurat objects and their names
  seurat1 <- reactiveVal(NULL)
  seurat2 <- reactiveVal(NULL)
  object1_name <- reactiveVal("Object 1")
  object2_name <- reactiveVal("Object 2")
  
  # Load Seurat objects when selected
  observeEvent(input$object1, {
    req(input$object1)
    seurat1(readRDS(file.path(seurat_dir, input$object1)))
    object1_name(input$object1)  # Set object name to the selected file name
    updateSelectInput(session, "cell_type", choices = unique(seurat1()$cell_type))  # Replace "cell_type" with your metadata column
  })
  
  observeEvent(input$object2, {
    req(input$object2)
    seurat2(readRDS(file.path(seurat_dir, input$object2)))
    object2_name(input$object2)  # Set object name to the selected file name
  })
  
  # Generate plots when the button is clicked
  observeEvent(input$plot, {
    req(seurat1(), input$gene1)
    
    # Feature Plots
    if (input$plot_type == "Feature Plot" || input$plot_type == "Both") {
      output$feature_plot1 <- renderPlot({
        FeaturePlot(seurat1(), features = input$gene1) + ggtitle(paste(object1_name(), "-", input$gene1))
      })
      
      output$feature_plot2 <- renderPlot({
        if (!is.null(seurat2())) {
          FeaturePlot(seurat2(), features = input$gene2) + ggtitle(paste(object2_name(), "-", input$gene2))
        }
      })
    }
    
    # Violin Plots
    if (input$plot_type == "Violin Plot" || input$plot_type == "Both") {
      output$violin_plot1 <- renderPlot({
        VlnPlot(seurat1(), features = input$gene1, group.by = input$cell_type) + ggtitle(paste(object1_name(), "-", input$gene1))
      })
      
      output$violin_plot2 <- renderPlot({
        if (!is.null(seurat2())) {
          VlnPlot(seurat2(), features = input$gene2, group.by = input$cell_type) + ggtitle(paste(object2_name(), "-", input$gene2))
        }
      })
    }
  })
}

# Run the app
shinyApp(ui = ui, server = server)

```


```{r}
library(shiny)
library(Seurat)
library(ggplot2)
library(patchwork)
library(shinycssloaders)  # For loading spinners

# Define the directory containing Seurat objects
seurat_dir <- "/data/gpfs/projects/punim2183/data_processed/"

# Define UI
ui <- fluidPage(
  titlePanel("Seurat Object Explorer"),
  sidebarLayout(
    sidebarPanel(
      textInput("object1", "Enter Seurat Object 1 Name", value = ""),
      textInput("object2", "Enter Seurat Object 2 Name", value = ""),
      textInput("gene1", "Enter Gene for Object 1", value = ""),
      textInput("gene2", "Enter Gene for Object 2", value = ""),
      selectInput("cell_type", "Choose Cell Type(s)", 
                  choices = c("Astrocytes", "Oligo", "Neurons"), 
                  multiple = TRUE),  # Allow multiple selections
      radioButtons("plot_type", "Choose Plot Type",
                   choices = c("Feature Plot", "Violin Plot", "Both"),
                   selected = "Both"),
      actionButton("plot", "Generate Plots")
    ),
    mainPanel(
      conditionalPanel(
        condition = "input.plot_type == 'Feature Plot' || input.plot_type == 'Both'",
        h4("Feature Plot"),
        fluidRow(
          column(6, withSpinner(plotOutput("feature_plot1"))),  # Add loading spinner
          column(6, withSpinner(plotOutput("feature_plot2")))   # Add loading spinner
        )
      ),
      conditionalPanel(
        condition = "input.plot_type == 'Violin Plot' || input.plot_type == 'Both'",
        h4("Violin Plot"),
        fluidRow(
          column(6, withSpinner(plotOutput("violin_plot1"))),   # Add loading spinner
          column(6, withSpinner(plotOutput("violin_plot2"))))   # Add loading spinner
        )
      )
    )
  )
)

# Define server logic
server <- function(input, output, session) {
  # Reactive values to store Seurat objects and their names
  seurat1 <- reactiveVal(NULL)
  seurat2 <- reactiveVal(NULL)
  object1_name <- reactiveVal("Object 1")
  object2_name <- reactiveVal("Object 2")
  
  # Load Seurat objects when names are provided
  observeEvent(input$object1, {
    req(input$object1)
    object_path <- file.path(seurat_dir, paste0(input$object1, ".RDS"))
    if (file.exists(object_path)) {
      showNotification("Loading Seurat Object 1...", type = "message")  # Progress message
      seurat1(readRDS(object_path))
      object1_name(input$object1)  # Set object name to the entered name
      showNotification("Seurat Object 1 loaded successfully!", type = "message")  # Progress message
    } else {
      showNotification("Seurat Object 1 not found!", type = "error")
    }
  })
  
  observeEvent(input$object2, {
    req(input$object2)
    object_path <- file.path(seurat_dir, paste0(input$object2, ".RDS"))
    if (file.exists(object_path)) {
      showNotification("Loading Seurat Object 2...", type = "message")  # Progress message
      seurat2(readRDS(object_path))
      object2_name(input$object2)  # Set object name to the entered name
      showNotification("Seurat Object 2 loaded successfully!", type = "message")  # Progress message
    } else {
      showNotification("Seurat Object 2 not found!", type = "error")
    }
  })
  
  # Generate plots when the button is clicked
  observeEvent(input$plot, {
    req(seurat1(), input$gene1, input$cell_type)  # Ensure cell types are selected
    
    # Filter data based on selected cell types
    filtered_seurat1 <- subset(seurat1(), subset = cell_type %in% input$cell_type)  # Replace "cell_type" with your metadata column
    filtered_seurat2 <- if (!is.null(seurat2())) subset(seurat2(), subset = cell_type %in% input$cell_type) else NULL
    
    # Show progress bar for plot generation
    withProgress(message = "Generating plots...", value = 0, {
      # Feature Plots
      if (input$plot_type == "Feature Plot" || input$plot_type == "Both") {
        incProgress(0.3, detail = "Generating Feature Plots...")  # Update progress
        output$feature_plot1 <- renderPlot({
          FeaturePlot(filtered_seurat1, features = input$gene1) + ggtitle(paste(object1_name(), "-", input$gene1))
        })
        
        output$feature_plot2 <- renderPlot({
          if (!is.null(filtered_seurat2)) {
            FeaturePlot(filtered_seurat2, features = input$gene2) + ggtitle(paste(object2_name(), "-", input$gene2))
          }
        })
      }
      
      # Violin Plots
      if (input$plot_type == "Violin Plot" || input$plot_type == "Both") {
        incProgress(0.6, detail = "Generating Violin Plots...")  # Update progress
        output$violin_plot1 <- renderPlot({
          VlnPlot(filtered_seurat1, features = input$gene1, group.by = "Class") + ggtitle(paste(object1_name(), "-", input$gene1))
        })
        
        output$violin_plot2 <- renderPlot({
          if (!is.null(filtered_seurat2)) {
            VlnPlot(filtered_seurat2, features = input$gene2, group.by = "Class") + ggtitle(paste(object2_name(), "-", input$gene2))
          }
        })
      }
      
      incProgress(1, detail = "Done!")  # Complete progress
    })
  })
}

# Run the app
shinyApp(ui = ui, server = server)

```