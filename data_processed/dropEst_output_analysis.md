## Load libraries

    library(Seurat)
    library(cowplot)
    library(dplyr)
    library(ggplot2)
    library(readr)
    library(DT)
    library(tidyr)
    library(patchwork)
    library(harmony)
    library(CSCORE)
    library(WGCNA)
    library(pheatmap)
    library(corrplot)
    library(rtracklayer)
    library(clusterProfiler)
    library(org.Mm.eg.db)
    library(enrichplot)
    library(glmGamPoi)


    source("/data/gpfs/projects/punim2183/data_processed/dropEst_analysis_functions.R")
    #save.image(file = "dropEst_output.RData")
    #load("dropEst_output.RData")

    knitr::opts_chunk$set(eval = FALSE)
     # 
     # knitr::knit("dropEst_output.Rmd", output = "dropEst_output_analysis.md")

    # rmarkdown::render("dropEst_output.Rmd", output_format = "md_document", output_file = "dropEst_output_analysis.md")

The Following steps explain how the Dropest generated count matrices are
converted and saved as an rds Seurat objects:

## Step 1: Reading count matrices from a directory and createing Seurat objects:

For each count matrix type (trunc, FL, orig and both) generated by
dropest using different gtf file.

    # Define the directory containing RDS files
    rds_directory_both <- "/data/gpfs/projects/punim2183/samples_processing/count_matrix_files/both"

    # Step 1: Read RDS files into Seurat objects
    seurat_list_both <- read_rds_to_seurat(rds_directory_both)

# Step 2: Rename cells in the Seurat objects:

Extract naming patterns from the names of Seurat objects. And rename
cell names in each Seurat object using the extracted naming patterns.
Then combine multiple Seurat objects into a single Seurat object.

*Extract the naming pattern (e.g., “10X05\_1”)*

**input** seurat\_objects\_both (a list of Seurat objects with names
like count\_matrix.rds\_10X05\_1.bam.1\_both.gtf).

**Output** Each Seurat object in seurat\_objects\_both now has cell
names prefixed with the corresponding naming pattern (e.g.,
“10X05\_1\_Cell\_1”).

    seurat_list_both <- rename_cells_in_seurat_objects(seurat_list_both)

# Step 3: Normalize and merge Seurat objects

Normalise each seurat object then merge into one object.

**Input:** List of seurat objects .

**Output:** A Normalised and merged Seurat object with:

    combined_seurat_both <- normalize_and_merge(seurat_list_both)

# Step 4: Update orig.ident metadata

Update the orig.ident metadata column based on the sample names
extracted from the cell names.

**input:** merged seurat object, **output:** updated metadata with
correspondent cell names.

    combined_seurat_both <- update_orig_ident(combined_seurat_both)

# Step 5: Process the merged Seurat object

Process the combined Seurat object by scaling, clustering, and filtering
the data.

**Input:** combined\_seurat\_both (the combined Seurat object).

**Output:** A processed Seurat object with:

-   scaled data.

-   PCA (npc = 20), clustering, and UMAP performed.

-   Cells filtered based on mitochondrial content (percent.mt &lt; 5),
    feature count (nFeature\_RNA &gt; 200 & nFeature\_RNA &lt; 2000),
    and RNA count.

<!-- -->

    combined_seurat_both <- process_seurat(combined_seurat_both)

# Step 6: Integrate datasets using Harmony

For addressing batch effect, grouped by orig.ident

# Step 7: Save the final Seurat object

# Both Seurat

*Processing “Both” originated Seurat*

Check the representation of the transcript isoforms as genes in the
metadata

## Further processing: clustering and cell type annotation:

Create clusters and annotate cell-types to clusters using marker genes
of cell types of interest

Check reductions done to the object for clustering, and join assay
layers for Seurat v5

# Assign Clusters to cell types of interest

## Subset seurat to cell types of interest for focused plotting

# CS\_core/ gene co-expression

## gene co-expression analysis:

### Ntrk2trunc

### Ntrk2FL

# GO enrichment

Prepare Gene Lists:

brain\_gene\_list\_FL contains genes correlated with the full-length
isoform (Ntrk2FL) with a correlation coefficient **(r) &gt; 0.2**.

brain\_gene\_list\_trunc contains genes correlated with the truncated
isoform (Ntrk2trunc) with a correlation coefficient **(r) &gt; 0.2**.

\*Convert Gene Symbols to ENTREZ IDs: Gene symbols (SYMBOL) are
converted to ENTREZID format using the bitr function from
clusterProfiler. This is necessary because GO enrichment analysis
typically works with ENTREZID.

\*Run GO Enrichment for Each Ontology: The function is applied to both
gene lists (for full-length and truncated isoforms) across three
different GO ontologies: Biological Process (BP), Molecular Function
(MF), and Cellular Component (CC).

\*Generate Plots: A GO enrichment dot plot is generated for each
combination of gene list and ontology.

Biological Process (BP): GO terms related to biological functions and
processes in the cell or organism.

Molecular Function (MF): GO terms that describe the molecular activities
of the gene products.

Cellular Component (CC): GO terms related to the location of the gene
product in the cell.

    # Get the GO results for Cellular Component
    go_results <- enrichGO(gene = brain_gene_list_FL, OrgDb = org.Mm.eg.db, ont = "CC", pvalueCutoff = 0.05)

    # Create a custom bar plot of the GO results
    ggplot(go_results@result, aes(x = reorder(Description, -p.adjust), y = -log10(p.adjust))) +
        geom_bar(stat = "identity", fill = "skyblue") +
        coord_flip() + 
        theme_minimal() +
        xlab("GO Terms") +
        ylab("-log10 Adjusted P-Value") +
        ggtitle("GO Enrichment - Cellular Component")


    go_data <- go_results@result

    # Custom ggplot for GO term enrichment
    ggplot(go_data, aes(x = reorder(Description, -Count), y = Count, fill = -log10(p.adjust))) +
        geom_bar(stat = "identity") +
        coord_flip() +
        scale_fill_gradient(low = "blue", high = "red") +
        labs(x = "GO Terms", y = "Gene Count", title = "GO Enrichment for Ntrk2FL") +
        theme_minimal()

# M10 Seurat

*Processing M10 originated Seurat*

    # Define the directory containing RDS files
    rds_directory_orig <- "/data/gpfs/projects/punim2183/samples_processing/count_matrix_files/orig"

    # 1. Load with renaming data
    seurat_list_M10 <- read_rds_to_seurat(rds_directory_orig) |>
      rename_cells_in_seurat_objects()

    # 2. Normalize with SCTransform and merge
    combined_seurat_M10 <- normalize_and_merge(seurat_list_M10) |>
      update_orig_ident()

    # 3. Process with Harmony integration
    combined_seurat_M10 <- process_seurat(combined_seurat_M10) |>
      run_harmony()

    # 4. Save the processed object
    saveRDS(combined_seurat_M10, "combined_seurat_M10.rds")


    # Print a success message
    print("Workflow completed successfully! The combined Seurat object has been saved.")
