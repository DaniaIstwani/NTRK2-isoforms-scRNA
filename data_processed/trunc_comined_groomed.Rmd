---
title: "Gene Co-expression and Clustering Analysis"
output: html_document
date: '2024-11-18'
---

```{r setup, include=FALSE}
# Load necessary libraries and functions
source("/data/gpfs/projects/punim2183/data_processed/dropEst_analysis_functions.R")
#save.image("combine_trunc")
#load("combine_trunc")
```

# Load data
```{r data_loading}
# Load count matrices for trunc data
#file_paths_trunc <- list.files("/data/gpfs/projects/punim2183/count_matrices", full.names = TRUE, pattern = "*_trunc*")
#count_matrices_trunc <- lapply(file_paths_trunc, readRDS)
#names(count_matrices_trunc) <- basename(file_paths_trunc)

#saveRDS(count_matrices_trunc, file = "count_matrices_trunc_named.rds")

#count_matrices_trunc <- readRDS("count_matrices_trunc_named.rds")

# Extract count matrices and align genes across datasets
count_matrices_extracted_trunc <- lapply(count_matrices_trunc, function(x) x[["cm"]])
all_genes_trunc <- Reduce(union, lapply(count_matrices_extracted_trunc, rownames))

aligned_matrices_trunc <- lapply(count_matrices_extracted_trunc, function(mat) {
  missing_genes <- setdiff(all_genes_trunc, rownames(mat))
  missing_mat <- Matrix::sparseMatrix(
    i = integer(0),
    j = integer(0),
    dims = c(length(missing_genes), ncol(mat)),
    dimnames = list(missing_genes, colnames(mat))
  )
  mat_combined <- rbind(mat, missing_mat)
  mat_combined[match(all_genes_trunc, rownames(mat_combined)), , drop = FALSE]
})

# Combine aligned matrices into a single Seurat object
combined_matrix_trunc <- do.call(cbind, aligned_matrices_trunc)
colnames(combined_matrix_trunc) <- make.unique(colnames(combined_matrix_trunc))

# Save the combined matrix with unique column names
saveRDS(combined_matrix_trunc, file = "combined_matrix_trunc.rds")


combined_seurat_trunc <- CreateSeuratObject(
  counts = combined_matrix_trunc,
  min.cells = 3,
  min.features = 200
)
```

# Preprocessing

```{r preprocessing}
# Add source information to metadata
source_ids_trunc <- unlist(lapply(names(count_matrices_trunc), function(name) {
  rep(name, ncol(count_matrices_extracted_trunc[[name]]))
}))
combined_seurat_trunc$source <- source_ids_trunc

# Preprocess the Seurat object
combined_seurat_trunc <- preprocess_seurat(combined_seurat_trunc)
```


# Visualization and Clustering
```{r visualization}
# Ntrk2trunc expression and clustering
FeaturePlot(combined_seurat_trunc, features = "Ntrk2trunc")
DimPlot(combined_seurat_trunc)

# Rename clusters for clarity
new_cluster_ids <- c("Neurons", "Astrocytes", "Neurons", "Oligo", "Oligo", "Cell_type_2", "Cell_type_3", "Cell_type_4", "Cell_type_5", "Cell_type_6")
names(new_cluster_ids) <- levels(combined_seurat_trunc)
combined_seurat_trunc <- RenameIdents(combined_seurat_trunc, new_cluster_ids)

# Subset specific cell types
cell_types_of_interest <- c("Neurons", "Astrocytes", "Oligo")
combined_seurat_trunc_subset <- subset(combined_seurat_trunc, idents = cell_types_of_interest)

DimPlot(combined_seurat_trunc_subset, reduction = "umap", label = TRUE, label.size = 5)
```

# Marker analysis
```{r marker_analysis}
# Find top markers for each cluster
markers <- FindAllMarkers(
  object = combined_seurat_trunc_subset,
  only.pos = TRUE,
  min.pct = 0.25,
  logfc.threshold = 0.25
)

# Extract top markers for specific cell types
top_markers <- markers %>% group_by(cluster) %>% top_n(n = 10, wt = avg_log2FC)
neurons_markers <- top_markers %>% filter(cluster == "Neurons")
astrocytes_markers <- top_markers %>% filter(cluster == "Astrocytes")

# Plot markers
DoHeatmap(combined_seurat_trunc_subset, features = unique(top_markers$gene)) + NoLegend()
DotPlot(combined_seurat_trunc_subset, features = c("Ntrk2trunc", "Slc1a2")) + RotatedAxis()
```

# Co-expression Analysis:
```{r coexpression_analysis}
# Perform co-expression analysis
astrocytes_coexp_trunc <- get_coexpression_with_gene(combined_seurat_trunc_subset, "Ntrk2trunc", "Astrocytes")
print(astrocytes_coexp_trunc)
```
